// Code generated by taurus_go/entity, DO NOT EDIT.

package entity

import (
	"context"
	"taurus_go_demo/entity/new/entity/geo_demo"
	"taurus_go_demo/entity/new/entity/internal"

	"github.com/zodileap/taurus_go/entity"
	"github.com/zodileap/taurus_go/entity/dialect"
	"github.com/zodileap/taurus_go/entity/entitysql"
)

// GeoEntityUpdate is the update action for the GeoEntity.
type GeoEntityUpdate struct {
	config     *internal.Dialect
	ctx        *entitysql.QueryContext
	tracker    entity.Tracker
	es         []*GeoEntity
	predicates [][]entitysql.PredicateFunc
	sets       []map[string]entitysql.CaseSpec
	total      int
	batchIndex []int
}

// newGeoEntityUpdate creates a new GeoEntityUpdate.
func newGeoEntityUpdate(c *internal.Dialect, es ...*GeoEntity) *GeoEntityUpdate {
	return &GeoEntityUpdate{
		config:     c,
		ctx:        &entitysql.QueryContext{},
		es:         es,
		predicates: [][]entitysql.PredicateFunc{},
		batchIndex: []int{0},
	}
}

func (o *GeoEntityUpdate) update(ctx context.Context, tx dialect.Tx) error {
	return o.sqlUpdate(ctx, tx)
}

func (o *GeoEntityUpdate) sqlUpdate(ctx context.Context, tx dialect.Tx) error {
	var (
		spec, err = o.updateSpec()
		res       = o.es
		cursor    = 0
	)
	if err != nil {
		return err
	}
	spec.Scan = func(rows dialect.Rows, fields []entitysql.ScannerField) error {
		e := res[cursor]
		cursor++
		args := e.scan(fields)
		if err := rows.Scan(args...); err != nil {
			return err
		} else {
			res = append(res, e)
			return e.setUnchanged()
		}
	}
	return entitysql.NewUpdate(ctx, tx, spec)
}

func (o *GeoEntityUpdate) updateSpec() (*entitysql.UpdateSpec, error) {
	spec := entitysql.NewUpdateSpec(geo_demo.Entity, geo_demo.Columns)
	if len(o.predicates) != len(o.sets) {
		return nil, entity.Err_0100030005
	}
	if err := o.setEntity(spec); err != nil {
		return nil, err
	}
	o.mergeArgs(spec)
	return spec, nil
}

// setEntity 用于在updateSpec中设置[]*GeoEntity的配置，
// 一般来说这个setEntity里的entity都是通过状态追踪，自动添加的。
func (o *GeoEntityUpdate) setEntity(spec *entitysql.UpdateSpec) error {
	predID := &geo_demo.PredID{}
	num := 0
	for i, e := range o.es {
		fields := e.config.Mutation.Fields()
		if len(fields) == 0 {
			return entity.Err_0100030002.Sprintf(e.config.Tag)
		}
		o.predicates = append(o.predicates, []entitysql.PredicateFunc{})
		o.sets = append(o.sets, map[string]entitysql.CaseSpec{})
		// 因为判断过predicates和set长度，所以这里默认等长
		index := len(o.predicates) - 1
		if i > 0 {
			o.predicates[index] = append(o.predicates[index], entitysql.Or, predID.EQ(e.Id.Get()))
		} else {
			o.predicates[index] = append(o.predicates[index], predID.EQ(e.Id.Get()))
		}
		num++
		for _, f := range fields {
			switch f {
			case geo_demo.FieldID.Name.String():
				v, err := e.Id.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldID.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.Id.SqlFormatParam()
				o.sets[index][geo_demo.FieldID.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldPoint.Name.String():
				v, err := e.Point.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldPoint.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.Point.SqlFormatParam()
				o.sets[index][geo_demo.FieldPoint.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldLineString.Name.String():
				v, err := e.LineString.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldLineString.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.LineString.SqlFormatParam()
				o.sets[index][geo_demo.FieldLineString.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldPolygon.Name.String():
				v, err := e.Polygon.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldPolygon.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.Polygon.SqlFormatParam()
				o.sets[index][geo_demo.FieldPolygon.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldMultiPoint.Name.String():
				v, err := e.MultiPoint.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldMultiPoint.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.MultiPoint.SqlFormatParam()
				o.sets[index][geo_demo.FieldMultiPoint.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldMultiLineString.Name.String():
				v, err := e.MultiLineString.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldMultiLineString.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.MultiLineString.SqlFormatParam()
				o.sets[index][geo_demo.FieldMultiLineString.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldMultiPolygon.Name.String():
				v, err := e.MultiPolygon.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldMultiPolygon.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.MultiPolygon.SqlFormatParam()
				o.sets[index][geo_demo.FieldMultiPolygon.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldCircularString.Name.String():
				v, err := e.CircularString.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldCircularString.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.CircularString.SqlFormatParam()
				o.sets[index][geo_demo.FieldCircularString.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldPointJson.Name.String():
				v, err := e.PointJson.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldPointJson.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.PointJson.SqlFormatParam()
				o.sets[index][geo_demo.FieldPointJson.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldLineStringJson.Name.String():
				v, err := e.LineStringJson.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldLineStringJson.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.LineStringJson.SqlFormatParam()
				o.sets[index][geo_demo.FieldLineStringJson.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldPolygonJson.Name.String():
				v, err := e.PolygonJson.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldPolygonJson.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.PolygonJson.SqlFormatParam()
				o.sets[index][geo_demo.FieldPolygonJson.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldMultiPointJson.Name.String():
				v, err := e.MultiPointJson.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldMultiPointJson.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.MultiPointJson.SqlFormatParam()
				o.sets[index][geo_demo.FieldMultiPointJson.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldMultiLineStringJson.Name.String():
				v, err := e.MultiLineStringJson.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldMultiLineStringJson.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.MultiLineStringJson.SqlFormatParam()
				o.sets[index][geo_demo.FieldMultiLineStringJson.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			case geo_demo.FieldMultiPolygonJson.Name.String():
				v, err := e.MultiPolygonJson.SqlParam(o.config.Driver.Dialect())
				if err != nil {
					return err
				}
				fieldSpace := entitysql.NewFieldSpec(geo_demo.FieldMultiPolygonJson.Name)
				fieldSpace.Param = v
				fieldSpace.ParamFormat = e.MultiPolygonJson.SqlFormatParam()
				o.sets[index][geo_demo.FieldMultiPolygonJson.Name.String()] = entitysql.CaseSpec{
					Field: fieldSpace,
					When:  predID.EQ(e.Id.Get()),
				}
				num++
			}
		}
		batchSize := *(entity.GetConfig().BatchSize)
		if (o.total+num)/batchSize > len(o.batchIndex) {
			o.batchIndex = append(o.batchIndex, len(o.predicates))
		} else {
			o.batchIndex[len(o.batchIndex)-1] = len(o.predicates)
		}
		o.total += num
	}
	return nil
}

func (o *GeoEntityUpdate) mergeArgs(spec *entitysql.UpdateSpec) {
	for i, end := range o.batchIndex {
		var begin int
		if i == 0 {
			begin = 0
		} else {
			begin = o.batchIndex[i-1]
		}
		pred := []entitysql.PredicateFunc{}
		set := map[string][]entitysql.CaseSpec{}
		for _, ps := range o.predicates[begin:end] {
			pred = append(pred, ps...)
		}
		for _, ss := range o.sets[begin:end] {
			for k, v := range ss {
				set[k] = append(set[k], v)
			}
		}
		spec.Predicate = append(spec.Predicate, func(p *entitysql.Predicate) {
			for _, f := range pred {
				f(p)
			}
		})
		spec.Sets = append(spec.Sets, set)
	}
}

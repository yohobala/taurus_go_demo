// Code generated by taurus_go/entity, DO NOT EDIT.

package internal

import (
	"context"

	"github.com/yohobala/taurus_go/entity"
	"github.com/yohobala/taurus_go/entity/dialect"
)

type Dialect struct {
	Tag    string
	Driver dialect.Driver
}

// NewDialect creates a new Dialect.
func NewDialect(tag string) (*Dialect, error) {
	c := &Dialect{
		Tag:    tag,
		Driver: nil,
	}
	err := c.initDriver()
	if err != nil {
		return nil, err
	}
	return c, nil
}

func (c *Dialect) initDriver() error {
	driver, err := entity.GetConnection(c.Tag)
	if err != nil {
		return err
	}
	c.Driver = driver
	return nil
}

func (b *Dialect) MayTx(ctx context.Context) (dialect.Tx, error) {
	tx, err := b.Driver.Tx(ctx)
	if err != nil {
		return nil, err
	}
	return tx, nil
}

// SetEntityState attempts to set the desired entity state
// if the conditions are not met.
func SetEntityState(m *entity.Mutation, state entity.EntityState) error {
	current := m.State()
	switch state {
	case entity.Unchanged:
		m.SetState(state)
	case entity.Added:
		if current == entity.Detached {
			m.SetState(state)
		} else {
			return entity.Err_0100030003.Sprintf("Added", "Detached")
		}
	case entity.Modified:
		if current == entity.Unchanged {
			m.SetState(state)
		} else if current == entity.Added {
			return nil
		} else {
			return entity.Err_0100030003.Sprintf("Modified", "Unchanged")
		}
	case entity.Deleted:
		if current == entity.Unchanged || current == entity.Modified || current == entity.Added {
			if current == entity.Unchanged || current == entity.Modified {
				m.SetState(state)
			} else {
				m.SetState(entity.Detached)
			}
		} else {
			return entity.Err_0100030003.Sprintf("Deleted", "Unchanged „ÄÅ Modified or Added")
		}
	case entity.Detached:
		if current == entity.Deleted {
			m.SetState(state)
		}
	}
	return nil
}

// Entity is the interface that wraps the basic methods for an entity.
type Entity interface {
}

// EntityConfig is the interface that wraps the basic methods for an entity config.
type EntityConfig interface {
	New() Entity
	Desc() EntityConfigDesc
}

// EntityConfigDesc is the entity config description.
type EntityConfigDesc struct {
	Name string
}

// QueryScanner is a struct that contains the configuration of the query scanner.
type QueryScanner struct {
	Config   EntityConfig
	Children []*QueryScanner
	TableNum int
}

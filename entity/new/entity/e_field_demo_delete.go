// Code generated by taurus_go/entity, DO NOT EDIT.

package entity

import (
	"context"
	"taurus_go_demo/entity/new/entity/field_demo"
	"taurus_go_demo/entity/new/entity/internal"

	"github.com/zodileap/taurus_go/entity"
	"github.com/zodileap/taurus_go/entity/dialect"
	"github.com/zodileap/taurus_go/entity/entitysql"
)

// FieldDemoEntityDelete is the delete action for the FieldDemoEntity.
type FieldDemoEntityDelete struct {
	config     *internal.Dialect
	es         []*FieldDemoEntity
	predicates []entitysql.PredicateFunc
}

// newFieldDemoEntityDelete creates a new FieldDemoEntityDelete.
func newFieldDemoEntityDelete(c *internal.Dialect, es ...*FieldDemoEntity) *FieldDemoEntityDelete {
	return &FieldDemoEntityDelete{
		config: c,
		es:     es,
	}
}

// Where adds a predicate to the delete action.
func (o *FieldDemoEntityDelete) Where(predicates ...entitysql.PredicateFunc) *FieldDemoEntityDelete {
	o.predicates = append(o.predicates, predicates...)
	return o
}

func (o *FieldDemoEntityDelete) delete(ctx context.Context, tx dialect.Tx) error {
	return o.sqlDelete(ctx, tx)
}

func (o *FieldDemoEntityDelete) sqlDelete(ctx context.Context, tx dialect.Tx) error {
	var (
		spec, err = o.deleteSpec()
		affected  = int64(0)
	)
	if err != nil {
		return err
	}
	spec.Affected = &affected
	if err := entitysql.NewDelete(ctx, tx, spec); err != nil {
		return err
	}
	for _, e := range o.es {
		if err := e.setState(entity.Detached); err != nil {
			return err
		}
	}
	return nil
}

func (o *FieldDemoEntityDelete) deleteSpec() (*entitysql.DeleteSpec, error) {
	spec := entitysql.NewDeleteSpec(field_demo.Entity)
	if ps := o.predicates; len(ps) > 0 {
		spec.Predicate = func(p *entitysql.Predicate) {
			for _, f := range ps {
				f(p)
			}
		}
	}
	predInt64F := &field_demo.PredInt64F{}
	if o.predicates == nil {
		o.predicates = make([]entitysql.PredicateFunc, 0, len(o.es))
	}
	for i, e := range o.es {
		if i >= 1 {
			o.predicates = append(o.predicates, entitysql.Or)
		}
		o.predicates = append(o.predicates, predInt64F.EQ(e.Int64F.Get()))
	}
	if ps := o.predicates; len(ps) > 0 {
		spec.Predicate = func(p *entitysql.Predicate) {
			for _, f := range ps {
				f(p)
			}
		}
	}
	return spec, nil
}
